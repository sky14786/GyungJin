<!DOCTYPE html>
<html lang="en">
  <head>
    <title>경진 ERP</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script type="text/javascript" src="../js/jquery.js"></script>
    <script type="text/javascript" src="../js/jquery_cookie.js"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <!-- <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css"
    />
    <script
      defer
      src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"
    ></script> -->
  </head>
  <body>
    <script>
      $(document).ready(function() {
        $("#header").load("../common/header.html?ver=2020031205");
      });
    </script>

    <style>
      .container-fluid {
        font-family: "Noto Sans KR", sans-serif;
      }
    </style>
    <div id="header"></div>
    <div class="container" style="margin-top: 1%">
      <div>
        <div style="font-size: 40px;margin-bottom: 20px;text-align: right;">
          <span class="text-dark">시공일지 등록</span>
        </div>
        <div class="input-group mb-4">
          <div class="input-group-prepend">
            <span class="input-group-text">거래명</span>
          </div>
          <input
            type="text"
            class="form-control"
            placeholder="XX아파트 X동 X호"
            id="traName"
          />
        </div>
        <div class="input-group mb-4">
          <div class="input-group-prepend">
            <span class="input-group-text">연락처</span>
          </div>
          <input
            type="text"
            class="form-control"
            placeholder="010-XXXX-XXXXX"
            id="traTel"
          />
        </div>
        <div class="input-group mb-4">
          <div class="input-group-prepend">
            <span class="input-group-text">고객명</span>
          </div>
          <input
            type="text"
            class="form-control"
            placeholder="홍길동"
            id="traCustomer"
          />
        </div>
        <div class="input-group mb-4">
          <div class="input-group-prepend">
            <span class="input-group-text">주소</span>
          </div>
          <input type="text" class="form-control" id="traAddr" readonly />
          <input
            class="btn btn-primary"
            type="button"
            onclick="addrSearch();"
            value="주소검색"
          />
        </div>
        <div class="input-group mb-4">
          <div class="input-group-prepend">
            <span class="input-group-text">상세주소</span>
          </div>
          <input
            type="text"
            class="form-control"
            placeholder="XX아파트 XX동 XX호"
            id="traAddrDetail"
          />
        </div>
        <div class="input-group mb-4">
          <div class="input-group-prepend">
            <span class="input-group-text">원가</span>
          </div>
          <input
            type="text"
            class="form-control"
            placeholder="40000000"
            id="traCost"
          />
        </div>
        <div class="input-group mb-4">
          <div class="input-group-prepend">
            <span class="input-group-text">세금</span>
          </div>
          <input
            type="text"
            class="form-control"
            placeholder="40000000"
            id="traTax"
          />
        </div>
        <div class="input-group mb-4">
          <div class="input-group-prepend">
            <span class="input-group-text">거래금액</span>
          </div>
          <input
            type="text"
            class="form-control"
            placeholder="40000000"
            id="traPrice"
          />
        </div>
        <div class="input-group mb-4">
          <div class="input-group-prepend">
            <span class="input-group-text mr-1">방문일자</span>
            <select class="form-control" id="year" style="width: 100px;">
              <option>선택안함</option>
            </select>
            <span class="mr-3 mt-1">년</span>

            <select class="form-control" id="month" style="width: 100px;">
              <option>선택안함</option>
            </select>
            <span class="mr-3 mt-1">월</span>
            <select class="form-control" id="day" style="width: 100px;">
              <option>선택안함</option>
            </select>
            <span class="mr-3 mt-1">일</span>
            <select class="form-control" id="hour" style="width: 100px;">
              <option>선택안함</option>
            </select>
            <span class="mr-3 mt-1">시</span>
            <select class="form-control" id="minute" style="width: 100px;">
              <option>선택안함</option>
            </select>
            <span class="mr-3 mt-1">분</span>
          </div>
        </div>

        <div class="form-group mb-4">
          <label for="comment">자제 상세 내용:</label>
          <textarea class="form-control" rows="3" id="traMaterial"></textarea>
        </div>
        <div class="form-group mb-4">
          <label for="comment">메모:</label>
          <textarea class="form-control" rows="3" id="traMemo"></textarea>
        </div>
        <div class="input-group mb-4">
          <div class="input-group-prepend">
            <span class="input-group-text mr-1">거래상태</span>
            <select class="form-control mr-5" id="traStatus">
              <option>선택안함</option>
            </select>
            <span class="input-group-text mr-1">분류</span>
            <select class="form-control" id="traCategory">
              <option>선택안함</option>
            </select>
          </div>
        </div>
        <div style="text-align: center;padding: 25px;">
          <button
            class="btn  btn-primary"
            style="margin-right:150px;width: 100px;height: 50px;font-size: 25px;"
            onclick="createTransaction();"
          >
            등록
          </button>
          <button
            class="btn  btn-info"
            style="width: 100px;height: 50px;font-size: 25px;"
          >
            취소
          </button>
        </div>
      </div>
    </div>
  </body>
  <script>
    var tradeCategory;

    $(document).ready(function() {
      dateSetting();
      tradeCategory = loadTradeCategory();
      createTradeCategory();
    });

    function addrSearch() {
      new daum.Postcode({
        oncomplete: function(data) {
          // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분입니다.
          // 예제를 참고하여 다양한 활용법을 확인해 보세요.
          $("#traAddr").val(data.roadAddress);
        }
      }).open();
    }

    function dateSetting() {
      for (var i = 0; i < 3; i++) {
        var option = $("<option>");
        $(option).text(i + 2020);
        $("#year").append(option);
      }

      for (var i = 0; i < 12; i++) {
        var option = $("<option>");
        $(option).text(i + 1);
        $("#month").append(option);
      }

      for (var i = 0; i < 24; i++) {
        var option = $("<option>");
        $(option).text(i + 1);
        $("#hour").append(option);
      }
      for (var i = 0; i < 31; i++) {
        var option = $("<option>");
        $(option).text(i + 1);
        $("#day").append(option);
      }
      for (var i = 0; i < 61; i++) {
        var option = $("<option>");
        $(option).text(i);
        $("#minute").append(option);
      }

      $("#traStatus").append($("<option>").text("예약"));
      $("#traStatus").append($("<option>").text("완료"));
    }

    function loadTradeCategory() {
      var obj = {
        url: "/api/tradeCategory",
        method: "GET",
        dataType: "json",
        contentType: "application/json; charset=UTF-8",
        async: false,
        result: {},
        success: function(data) {
          obj.result = data;
        },
        error: function(request, status, error) {
          ajaxError(request, status, error);
        }
      };
      $.ajax(obj);
      return obj.result;
    }

    function createTradeCategory() {
      $.each(tradeCategory, function(index, item) {
        $("#traCategory").append(
          $("<option>")
            .attr("name", item.tradeCode)
            .text(item.tradeName)
        );
      });
    }

    function createTransaction() {
      if (!validationData()) {
        return false;
      }
      var transaction = {};
      transaction.traName = $("#traName").val();
      transaction.traTel = $("#traTel").val();
      transaction.traCustomer = $("#traCustomer").val();
      transaction.traAddr = $("#traAddr").val();
      transaction.traAddrDetail = $("#traAddrDetail").val();
      transaction.traCost = $("#traCost").val();
      transaction.traTax = $("#traTax").val();
      transaction.traPrice = $("#traPrice").val();
      transaction.traVisitDate = getVisitDate();
      transaction.traStatus = $("#traStatus").val();
      transaction.traMaterial = $("#traMaterial").val();
      transaction.traMemo = $("#traMemo").val();
      $.each(tradeCategory, function(index, item) {
        if (item.tradeName == $("#traCategory").val()) {
          transaction.traCategory = item.tradeCode;
        }
      });

      $.ajax({
        url: "/api/transaction",
        method: "POST",
        data: JSON.stringify(transaction),
        dataType: "json",
        contentType: "application/json; charset=UTF-8",
        success: function(data) {
          if (data) {
            alert("등록했습니다.");
          } else {
            alert("등록에 실패했습니다.");
          }
          $(location).attr(
            "href",
            $(location).attr("host") + "/view/Transaction.html"
          );
        },
        error: function(request, status, error) {
          ajaxError(request, status, error);
        },
        beforeSend: function() {
          loadingDisplayOn();
        },
        complete: function() {
          loadingDisplayOff();
        }
      });
    }

    function validationData() {
      if ($("#traName").val() == "") {
        alert("거래명을 입력해 주세요.");
        return false;
      }
      if ($("#traTel").val() == "") {
        alert("연락처를 입력해 주세요.");
        return false;
      }
      if ($("#traAddr").val() == "") {
        alert("주소를 검색해 주세요.");
        return false;
      }
      if ($("#traAddrDetail").val() == "") {
        alert("상세주소를 입력해 주세요.");
        return false;
      }
      if ($("#traCost").val() == "") {
        alert("원가를 입력해 주세요.");
        return false;
      }
      if ($("#traTax").val() == "") {
        alert("세금을 입력해 주세요.");
        return false;
      }
      if ($("#traPrice").val() == "") {
        alert("거래금액을 입력해 주세요.");
        return false;
      }
      return true;
    }

    function getVisitDate() {
      var result = "";
      if ($("#year").val() == "선택안함") {
        alert("방문년도를 선택해 주세요.");
        return false;
      }
      result += $("#year").val() + "년 ";
      if ($("#month").val() == "선택안함") {
        alert("방문월을 선택해 주세요.");
        return false;
      }
      result += $("#month").val() + "월 ";
      if ($("#day").val() == "선택안함") {
        alert("방문일을 선택해 주세요.");
        return false;
      }
      result += $("#day").val() + "일 ";
      if ($("#hour").val() == "선택안함") {
        alert("방문시간을 선택해 주세요.");
        return false;
      }
      result += $("#hour").val() + "시 ";
      if ($("#minute").val() == "선택안함") {
        alert("방문시간을 선택해 주세요.");
        return false;
      }
      result += $("#minute").val() + "분";

      return result;
    }
  </script>

  <style>
    #pageBar > a {
      color: black !important;
      margin: 4px !important;
      font-size: 20px;
    }
    #pageBar > .cPage {
      margin: 4px !important;
      color: grey !important;
      font-size: 22px;
    }
    .list-padding {
      padding: 10px 5px;
    }
  </style>
</html>
